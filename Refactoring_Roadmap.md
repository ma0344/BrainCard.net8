# リファクタリングロードマップ（WPF Ink → SkiaSharp / 旧ISFは読み込み専用）

本ドキュメントは、WPF版のInk実装を **SkiaSharp（`SkiaSharp.Views.WPF`）** ベースへ移行し、旧形式（`.bcf` 内のISF）は読み込み専用として維持するための実装手順（Steps）をまとめたものです。

## 前提・意思決定
- UIは **WPFを継続**する（WinUI 3 移行は本ロードマップの対象外）
- Ink編集ビューは **`SubWindow` のみ**を置換対象とする（`MainWindow` のカード表示は PNG のみ）
- `MainWindow` は **PNG生成を担わない**
  - Keepクリック時のカード生成（表示用PNG作成を含む）
  - ファイル読み込み時にPNGキャッシュが無い場合のカード生成（表示用PNG作成を含む）
  は **`SubWindow` の責務**とする
- PNGキャッシュは `*.bcf2.Assets\<cardId>.png` を継続利用する
  - Hot Reloadで描画ロジックを変更しても、既存カード表示はPNGキャッシュ参照のため即時反映されない
  - 開発時は「キャッシュ削除→（再生成トリガ）→表示更新」で差分確認する
- 入力デバイスは **ペン（筆圧必須）/マウス/タッチ**など、全ポインティングデバイスを対象とする
  - 最小到達点ではマウスのみで可
- 消しゴムは **結果のみ保存**し、**ストローク単位で削除**する（部分消去は想定しない）
- 旧データ互換は **パターン1**：旧`.bcf`を読み込み可能にし、保存時は **常に新拡張子へ強制**する（旧拡張子では保存不可）
- 点列の時刻 `t` は、
  - 新方式収集時は取得できる範囲で保持
  - 旧ISFから復元できない場合は **速度推定**で補完する

## ゴール（逆算）
- 旧`.bcf`を読み込み→表示（PNG生成含む）できる
- `SubWindow`で再編集できる
- 保存時は常に新拡張子へ強制できる
- 新ファイルを読み込み→再編集→再保存できる

## 最小到達点（先に検証可能性を作る）
- **ポインティングデバイス入力（最低限はマウス/単色/一定筆圧で可）を受け取り**
- **SkiaSharpで新ストロークを描画し**
- **表示内容からPNGを生成し（537x380px固定）**
- **`MainWindow` にカード（PNG）として追加できる**

## 重要仕様（PNG固定サイズ / 基準キャンバス）
- 基準キャンバス（編集モデルの座標系）
  - `Values.cardWidth=537`, `Values.cardHeight=380` を **基準キャンバス（DIP）** とする
  - ストローク点列は **基準キャンバス座標（DIP）** として保持する
  - `SubWindow` の表示サイズは倍率（ViewScale）として扱い、座標/線幅も同率でスケールする
- PNG生成
  - 出力PNGは **常に 537x380 px 固定**とする（`SubWindow` の表示サイズに依存しない）
  - 望ましい方式は「UWP InkCanvasと同様に、ストロークデータをスケーリングしてからレンダリングする（=描画変換を統一する）」
  - 将来の高解像度出力は倍率を掛ける方式で拡張可能にする

## Plan Steps
1. ✅ **リポジトリ構成を調査する**
   - ✅ `SubWindow` / `Card` / 保存読込 / PNG生成の責務分割を確認する
   - ✅ `MyUWPApp` の残存依存箇所を確認する

2. ? **旧Ink依存箇所を棚卸しする**
   - ✅ `Windows.UI.Input.Inking` / `Windows.UI.Xaml.*` / `Microsoft.Toolkit.*` の使用箇所を列挙する
   - ✅ 編集ビュー（SubWindow）・PNG生成・保存/読込の経路を整理する

3. ✅ **新ファイル形式（v2）仕様を確定する**
   - ✅ 新拡張子（`.bcf2`）を確定する
   - ✅ データ単位（ファイル→カード→ストローク→点）と必須/任意項目を確定する
   - ✅ 単位（DIP）と点列 `p[].t` の定義（相対ms、開始=0）を確定する
   - ✅ 消しゴムは「結果のみ保存」かつ「ストローク単位削除」を確定する
   - ✅ 旧形式保存の禁止（UI/拡張子/フィルタ/上書き挙動）を確定する

4. ? **新データモデルを追加する**
   - ✅ v2用データクラス（ファイル/カード/ストローク/点）を追加する
   - ✅ JSONシリアライズ/デシリアライズ方法を確定する（Newtonsoft継続）

5. ✅ **SkiaSharpでの最小入力と描画を成立させる**
   - ✅ SubWindow 上に `SKElement` をホストできるようにする `docs/issues/ISSUE-SKIA-005-01-host-in-subwindow.md`
   - ✅ 1ストローク分の入力収集（マウス）を実装する（押下→移動→離す） `docs/issues/ISSUE-SKIA-005-02-pointer-input-collect.md`
   - ✅ 収集した点列を即時描画できるようにする（スムージング不要） `docs/issues/ISSUE-SKIA-005-03-rendering.md`

6. ✅ **SkiaSharpでPNG生成してカード化できるようにする**
   - ✅ Keepで `MainWindow` にカード（PNG）を追加/更新できるようにする（成果物契約を整備） `docs/issues/ISSUE-SKIA-000-overview.md`
   - ✅ PNGを **537x380px固定**で生成できるようにする `docs/issues/ISSUE-SKIA-005-04-png-generation.md`
   - ✅ 空ストロークのカードを作成しない（新規は追加しない／編集は削除確認）

7. ✅ **新形式（v2）の保存/読込経路を追加する**
   - ✅ v2ファイル読み込み処理を追加する `docs/issues/ISSUE-SKIA-007-01-v2-read.md`
   - ✅ v2ファイル保存処理を追加する `docs/issues/ISSUE-SKIA-007-02-v2-save.md`
   - `Assets`（PNGキャッシュ）フォルダ運用を継続する
   - ✅ SaveAsで既存ファイルに保存した場合のAssets残留をクリーンアップする `docs/issues/ISSUE-SKIA-007-03-clean-assets-on-save.md`

8. ✅ **保存時に新拡張子へ強制する**
   - ✅ 旧拡張子（`.bcf`）での保存・上書きを禁止する `docs/issues/ISSUE-SKIA-008-01-force-bcf2-save.md`
   - ✅ 旧ファイルを開いて保存する場合は必ず「名前を付けて保存」で新拡張子を提示する
   - ✅ UI文言（メッセージ/フィルタ）を更新する

9. ✅**旧`.bcf` 読み込み経路を分離する**
   - ✅旧`.bcf` 読み込み処理を残す（互換読み込み） `docs/issues/ISSUE-SKIA-009-01-legacy-bcf-read-split.md`
   - ✅旧ISFを `InkStrokeContainer.LoadAsync()` で復元できる状態にする
   - ✅読み込み後、内部表現は新モデルに統一する

10. **旧ISF→新ストローク形式への変換機能を実装する**
    - `InkStroke` から点列（x,y,pressure,t）と描画属性（色、太さ、透過、蛍光ペン等）を抽出する `docs/issues/ISSUE-SKIA-010-01-isf-to-v2-convert.md`
    - `t` が得られない場合は **速度推定で補完**して格納する

11. **消しゴム処理をストローク削除で実装する**
    - 消しゴム入力（右クリック押下/ペン裏）を判定する `docs/issues/ISSUE-SKIA-011-01-eraser-stroke-delete.md`
    - ヒット判定で対象ストロークを **削除**する（部分消去・操作ログ・Undo/Redoなし）

12. **ビルドと動作確認を行う**
    - `.NET 8` でビルドが通ることを確認する
    - 旧`.bcf` を読み込み→表示（PNG生成含む）→新拡張子へ保存できることを確認する
    - 新ファイルを読み込み→再編集→保存できることを確認する
+
+13. ✅ **開発時のキャッシュクリア機能を追加する**
+    - ✅ `MainWindow` に `ui:SplitButton` のキャッシュクリアUIを追加する（デフォルト: PNGのみクリア）
+    - ✅ Flyoutで `PNGのみ` / `PNG+ノイズ` を選択できるようにする
+    - ✅ ノイズキャッシュ（`PencilBrushTexture`）をクリアできるAPIを追加する
+    - メモ: 既存カード表示はPNGキャッシュ参照のため、Hot Reloadでレンダラ変更してもPNG再生成までは反映されない
+
+14. ? **描画パリティの課題を解決する**
+    - Pencilストローク周囲に発生する「描画方向に平行な線（ストライプ/バンディング）」を解消する
+    - `Pressure` の値に応じて不透明度（必要に応じて線幅も）を変化させる
+    - 参考: `docs/issues/ISSUE-SKIA-010-01-04-skiasharp-render-parity.md`

## メモ
- 本ロードマップは「設計→移行の道筋」を示すものであり、各ステップは実装状況に応じて分割・統合される可能性があります。











