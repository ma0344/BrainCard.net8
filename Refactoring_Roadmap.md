# リファクタリングロードマップ（WPF Ink → Win2D / 旧ISFは読み込み専用）

本ドキュメントは、WPF版のInk実装をWin2Dベースへ移行し、旧形式（`.bcf` 内のISF）は読み込み専用として維持するための実装手順（Steps）をまとめたものです。

## 前提・意思決定
- UIは **WPFを継続**する（WinUI 3 移行は本ロードマップの対象外）
- Ink編集ビューは **`SubWindow` のみ**を置換対象とする（`MainWindow` のカード表示は PNG のみ）
- 入力デバイスは **ペン（筆圧必須）/マウス/タッチ**など、全ポインティングデバイスを対象とする
- 消しゴムは **結果のみ保存**し、**ストローク単位で削除**する（部分消去は想定しない）
- 旧データ互換は **パターン1**：旧`.bcf`を読み込み可能にし、保存時は **常に新拡張子へ強制**する（旧拡張子では保存不可）
- 点列の時刻 `t` は、
  - 新方式収集時は取得できる範囲で保持
  - 旧ISFから復元できない場合は **速度推定**で補完する

## ゴール（逆算）
- 旧`.bcf`を読み込み→表示（PNG生成含む）できる
- `SubWindow`で再編集できる
- 保存時は常に新拡張子へ強制できる
- 新ファイルを読み込み→再編集→再保存できる

## 最小到達点（先に検証可能性を作る）
- **ポインティングデバイス入力（最低限はマウス/単色/一定筆圧で可）を受け取り**
- **Win2Dで新ストロークを描画し**
- **表示されている内容をPNG化して**
- **`MainWindow` にカード（PNG）として追加できる**

## Plan Steps
1. ? **リポジトリ構成を調査する**
   - ? `SubWindow` / `Card` / 保存読込 / PNG生成の責務分割を確認する
   - ? `MyUWPApp` の残存依存箇所を確認する

2. ? **旧Ink依存箇所を棚卸しする**
   - ? `Windows.UI.Input.Inking` / `Windows.UI.Xaml.*` / `Microsoft.Toolkit.*` の使用箇所を列挙する
   - ? 編集ビュー（SubWindow）・PNG生成・保存/読込の経路を整理する

3. ? **新ファイル形式（v2）仕様を確定する**
   - ? 新拡張子（例：`.bcf2`）を確定する
   - ? データ単位（ファイル→カード→ストローク→点）と必須/任意項目を確定する
   - ? 単位（DIP）と点列 `p[].t` の定義（相対ms、開始=0）を確定する
   - ? 消しゴムは「結果のみ保存」かつ「ストローク単位削除」を確定する
   - ? 旧形式保存の禁止（UI/拡張子/フィルタ/上書き挙動）を確定する

4. ? **新データモデルを追加する**
   - ? v2用データクラス（ファイル/カード/ストローク/点）を追加する
   - ? JSONシリアライズ/デシリアライズ方法を確定する（Newtonsoft継続）

5. **Win2Dでの最小入力と描画を成立させる**
   - 5-1 ? SubWindow 上でWin2D描画ビューをホストできるようにする（`HwndHost` 等） `docs/issues/ISSUE-005-01-win2d-host-in-subwindow.md`
   - 5-2 ? 1ストローク分の入力収集（マウス）を実装する（押下→移動→離す） `docs/issues/ISSUE-005-02-pointer-input-collect.md`
   - 5-3 ? 点列の座標系（DIP）とサンプリング方針（移動イベント毎＋必要なら最小距離閾値）を確定する `docs/issues/ISSUE-005-03-coordinates-and-sampling.md`
   - 5-4 ? 描画属性の最小セットを確定する（単色・固定太さ・固定筆圧） `docs/issues/ISSUE-005-04-min-drawing-attributes.md`
   - 5-5 ? 新ストロークモデル（v2）へ反映できるようにする（まずはメモリ内） `docs/issues/ISSUE-005-05-map-to-v2-stroke-model.md`
   - 5-6 ? 収集した点列を即時描画できるようにする（スムージング不要） `docs/issues/ISSUE-005-06-immediate-rendering.md`

6. ? **Win2DでPNG生成してカード化できるようにする**
   - ? Keep/Applyで `MainWindow` にカード（PNG）を追加/更新できるようにする（暫定経路）
   - ? 空ストロークのカードを作成しない（新規は追加しない／編集は削除確認）

7. **新形式（v2）の保存/読込経路を追加する**
   - v2ファイル読み込み処理を追加する
   - `Assets`（PNGキャッシュ）フォルダ運用を継続する

8. **保存時に新拡張子へ強制する**
   - 旧拡張子（`.bcf`）での保存・上書きを禁止する
   - 旧ファイルを開いて保存する場合は必ず「名前を付けて保存」で新拡張子を提示する
   - UI文言（メッセージ/フィルタ）を更新する

9. **旧`.bcf` 読み込み経路を分離する**
   - 旧`.bcf` 読み込み処理を残す（互換読み込み）
   - 旧ISFを `InkStrokeContainer.LoadAsync()` で復元できる状態にする
   - 読み込み後、内部表現は新モデルに統一する

10. **旧ISF→新ストローク形式への変換機能を実装する**
    - `InkStroke` から点列（x,y,pressure,t）と描画属性（色、太さ、透過、蛍光ペン等）を抽出する
    - `t` が得られない場合は **速度推定で補完**して格納する

11. **消しゴム処理をストローク削除で実装する**
    - 消しゴム入力（右クリック押下/ペン裏）を判定する
    - ヒット判定で対象ストロークを **削除**する（部分消去・操作ログ・Undo/Redoなし）

12. **ビルドと動作確認を行う**
    - `.NET 8` でビルドが通ることを確認する
    - 旧`.bcf` を読み込み→表示（PNG生成含む）→新拡張子へ保存できることを確認する
    - 新ファイルを読み込み→再編集→保存できることを確認する

## メモ
- 本ロードマップは「設計→移行の道筋」を示すものであり、各ステップは実装状況に応じて分割・統合される可能性があります。

