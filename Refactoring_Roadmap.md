# リファクタリングロードマップ（WPF Ink → Win2D / 旧ISFは読み込み専用）

本ドキュメントは、WPF版のInk実装をWin2Dベースへ移行し、旧形式（`.bcf` 内のISF）は読み込み専用として維持するための実装手順（Steps）をまとめたものです。

## 前提・意思決定
- UIは **WPFを継続**する（WinUI 3 移行は本ロードマップの対象外）
- Ink編集ビューは **`SubWindow` のみ**を置換対象とする（`MainWindow` のカード表示は PNG のみ）
- 入力デバイスは **ペン（筆圧必須）/マウス/タッチ**など、全ポインティングデバイスを対象とする
- 消しゴムは **結果のみ保存**し、**ストローク単位で削除**する（部分消去は想定しない）
- 旧データ互換は **パターン1**：旧`.bcf`を読み込み可能にし、保存時は **常に新拡張子へ強制**する（旧拡張子では保存不可）
- 点列の時刻 `t` は、
  - 新方式収集時は取得できる範囲で保持
  - 旧ISFから復元できない場合は **速度推定**で補完する

## Plan Steps
1. **リポジトリ構成を調査する**
   - `SubWindow` / `Card` / 保存読込 / PNG生成の責務分割を確認する
   - `MyUWPApp` の残存依存箇所を確認する

2. **旧Ink依存箇所を棚卸しする**
   - `Windows.UI.Input.Inking` / `Windows.UI.Xaml.*` / `Microsoft.Toolkit.*` の使用箇所を列挙する
   - 編集ビュー（SubWindow）・PNG生成・保存/読込の経路を整理する

3. **新ファイル形式（v2）仕様を確定する**
   - 新拡張子（例：`.bcf2`）を確定する
   - データ単位（ファイル→カード→ストローク→点）と必須/任意項目を確定する
   - 単位（DIP）と点列 `p[].t` の定義（相対ms、開始=0）を確定する
   - 消しゴムは「結果のみ保存」かつ「ストローク単位削除」を確定する
   - 旧形式保存の禁止（UI/拡張子/フィルタ/上書き挙動）を確定する

4. **新データモデルを追加する**
   - v2用データクラス（ファイル/カード/ストローク/点）を追加する
   - JSONシリアライズ/デシリアライズ方法を確定する（Newtonsoft継続）

5. **新形式の保存/読込経路を追加する**
   - v2ファイル読み込み処理を追加する
   - `Assets`（PNGキャッシュ）フォルダ運用を継続する

6. **旧`.bcf` 読み込み経路を分離する**
   - 旧`.bcf` 読み込み処理を残す（互換読み込み）
   - 旧ISFを `InkStrokeContainer.LoadAsync()` で復元できる状態にする
   - 読み込み後、内部表現は新モデルに統一する

7. **旧ISF→新ストローク形式への変換機能を実装する**
   - `InkStroke` から点列（x,y,pressure,t）と描画属性（色、太さ、透過、蛍光ペン等）を抽出する
   - `t` が得られない場合は **速度推定で補完**して格納する

8. **SubWindow の編集ビューを Win2D ベースで実装する**
   - WPF上で動くWin2D描画ビューを実装する（例：`HwndHost` + SwapChain 等）
   - ペン/マウス/タッチの入力を統一的に扱うイベント収集を実装する
   - 取得した入力から新ストロークモデル（点列＋筆圧＋t）を生成する

9. **消しゴム処理をストローク削除で実装する**
   - 消しゴム入力（右クリック押下/ペン裏）を判定する
   - ヒット判定で対象ストロークを **削除**する（部分消去・操作ログ・Undo/Redoなし）

10. **PNG生成処理を Win2D 側へ移行する**
   - v2ストロークからPNGを生成する処理を実装する（編集完了時・読み込み時に利用）
   - 旧方式の `Windows.UI.Xaml.Media.Imaging.RenderTargetBitmap` 依存を排除する

11. **保存時に新拡張子へ強制する**
   - 旧拡張子（`.bcf`）での保存・上書きを禁止する
   - 旧ファイルを開いて保存する場合は必ず「名前を付けて保存」で新拡張子を提示する
   - UI文言（メッセージ/フィルタ）を更新する

12. **ビルドと動作確認を行う**
   - `.NET 8` でビルドが通ることを確認する
   - 旧`.bcf` を読み込み→表示（PNG生成含む）→新拡張子へ保存できることを確認する
   - 新ファイルを読み込み→再編集→保存できることを確認する

## メモ
- 本ロードマップは「設計?移行の道筋」を示すものであり、各ステップは実装状況に応じて分割・統合される可能性があります。
