using System;
using Windows.UI.Core;
using Windows.UI.Input.Inking;
using Windows.UI.Xaml;
using Windows.UI.Xaml.Controls;
using Windows.UI.Xaml.Media;


// ユーザー コントロールの項目テンプレートについては、https://go.microsoft.com/fwlink/?LinkId=234236 を参照してください

namespace MyUWPApp
{
    public sealed partial class CustomInkCanvas : Grid
    {
        public EventHandler Drawing;
        public InkCanvas InnerInkCanvas => InkCanvas;
        public InkPresenter InnerPresenter => InkCanvas.InkPresenter;
        public Image TestPict => TestPictImage;

        public Grid BaseGrid => Basegrid;
        public bool IsWritable;
        
        public CustomInkCanvas(bool Writable = false)
        {
            this.InitializeComponent();
            IsWritable = Writable;
            InkCanvas.IsHitTestVisible = false;
            InkCanvas.InkPresenter.StrokeInput.StrokeStarted += StrokeInput_StrokeStarted;
        }

        private void StrokeInput_StrokeStarted(InkStrokeInput sender, PointerEventArgs args)
        {
            OnDrawing();
        }

        private void InkCanvas_OnLoaded(object sender, RoutedEventArgs e)
        {
            if (IsWritable)
                InkCanvas.InkPresenter.InputDeviceTypes = CoreInputDeviceTypes.Mouse | CoreInputDeviceTypes.Touch | CoreInputDeviceTypes.Pen;
            else
            {
                InkCanvas.InkPresenter.InputDeviceTypes = CoreInputDeviceTypes.None;

            }
        }

        public CustomInkCanvas Clone()
        {

            var clonedCanvas = new CustomInkCanvas(IsWritable);
            foreach (var stroke in InkCanvas.InkPresenter.StrokeContainer.GetStrokes())
            {
                clonedCanvas.InkCanvas.InkPresenter.StrokeContainer.AddStroke(stroke.Clone());
            }
            clonedCanvas.Width = Width;
            clonedCanvas.Height = Height;
            return clonedCanvas;
        }

        public void SetInnerCanvas(InkCanvas inkCanvas)
        {
            
            var width = this.ActualWidth;
            var height = this.ActualWidth;
            var aspect = Math.Min(width / Values.cardWidth, height / Values.cardHeight);
            var renderTransform = new ScaleTransform();
            renderTransform.ScaleX = aspect;
            renderTransform.ScaleY = aspect;

            
            var strokeContainer = inkCanvas.InkPresenter.StrokeContainer;
            this.InkCanvas.InkPresenter.StrokeContainer.Clear();
            foreach (var stroke in strokeContainer.GetStrokes())
            {

                this.InkCanvas.InkPresenter.StrokeContainer.AddStroke(stroke.Clone());
            }
            
            this.InkCanvas.RenderTransform = renderTransform;
        }

        public InkCanvas CloneInkCanvas()
        {
            var clonedCanvas = new InkCanvas();
            foreach (var stroke in InkCanvas.InkPresenter.StrokeContainer.GetStrokes())
            {
                clonedCanvas.InkPresenter.StrokeContainer.AddStroke(stroke.Clone());
            }
            clonedCanvas.Width = Width;
            clonedCanvas.Height = Height;
            return clonedCanvas;
        }

        public void OnDrawing()
        {
            Drawing?.Invoke(this, new EventArgs());
        }
    }

}
