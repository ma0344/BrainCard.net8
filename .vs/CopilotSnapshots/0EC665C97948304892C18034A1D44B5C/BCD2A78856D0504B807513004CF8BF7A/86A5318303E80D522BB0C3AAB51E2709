using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.DirectoryServices.ActiveDirectory;
using System.IO;
using System.Linq;
using System.Runtime.InteropServices;
using System.Runtime.InteropServices.WindowsRuntime;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Controls.Primitives;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Animation;
using System.Windows.Media.Imaging;
using System.Windows.Media.Media3D;
using System.Windows.Shapes;
using System.Windows.Shell;
using Microsoft.Toolkit.Wpf.UI.Controls;
using Microsoft.Toolkit.Wpf.UI.XamlHost;
using ModernWpf;
using ModernWpf.Controls;
using MyUWPApp;
using Windows.ApplicationModel.UserDataAccounts.SystemAccess;
using Windows.Storage.Streams;
using Windows.UI.Input.Inking;
using Windows.UI.Input.Inking.Analysis;
using Windows.UI.Xaml.Media.Imaging;
using static BrainCard.Values;
using forms = System.Windows.Forms;
namespace BrainCard
{

    /// <summary>
    /// SubWindow.xaml の相互作用ロジック
    /// </summary>
    public partial class SubWindow : Window
    {
        // WINDOWPOS構造体の定義
        [StructLayout(LayoutKind.Sequential)]
        private struct WINDOWPOS
        {
            public IntPtr hwnd;
            public IntPtr hwndInsertAfter;
            public int x;
            public int y;
            public int cx;
            public int cy;
            public int flags;
        }

        [System.Runtime.InteropServices.DllImport("user32.dll", SetLastError = true)]
        private static extern bool SetWindowPos(IntPtr hWnd, IntPtr hWndInsertAfter, int X, int Y, int cx, int cy, uint uFlags);


        // RECT 構造体の定義
        [System.Runtime.InteropServices.StructLayout(System.Runtime.InteropServices.LayoutKind.Sequential)]
        private struct RECT
        {
            public int Left;
            public int Top;
            public int Right;
            public int Bottom;
        }

        public double heightGap;
        public double widthGap;
        private int currentSizingEdge = 0;
        private double windowTop = 100;
        private double windowLeft = 100;

        // サイズ変更エッジの定数
        private const int WMSZ_LEFT = 1;
        private const int WMSZ_RIGHT = 2;
        private const int WMSZ_TOP = 3;
        private const int WMSZ_TOPLEFT = 4;
        private const int WMSZ_TOPRIGHT = 5;
        private const int WMSZ_BOTTOM = 6;
        private const int WMSZ_BOTTOMLEFT = 7;
        private const int WMSZ_BOTTOMRIGHT = 8;

        // メッセージ定数
        private const int WM_SIZING = 0x0214;
        private const int WM_WINDOWPOSCHANGING = 0x0046;
        private const int WM_SHOWWINDOW = 0x0018;
        private const int WM_EXITSIZEMOVE = 0x0232;
        private const int WM_SYSCOMMAND = 0x0112;
        private const int SC_MINIMIZE = 0xF020;


        public forms.Screen currentScreen;
        public EventHandler WindowLoaded;

        private MainWindow mainWindow;
        public WindowsXamlHost CardInkCanvasHost;
        public Windows.UI.Xaml.Controls.InkCanvas cardInkCanvas;
        public Windows.UI.Xaml.Controls.Grid cardBaseGrid;
        public CustomInkCanvas customInkCanvas;
        public CustomInkToolbar customInkToolbar;
        public CustomInkCanvas resizeInkCanvas;
        public WindowsXamlHost ResizeInkCanvasHost;
        public Windows.UI.Xaml.Controls.Image testPict;
        private RECT prevPoint = new RECT();
        private WindowChrome windowChrome;
        private Border imageBaseBorder = new Border();
        private SplitView splitView;
        private ToggleButton inkToolbarToggleButton;

        private Windows.UI.Xaml.Hosting.WindowsXamlManager _windowsXamlManager;

        public SubWindow(MainWindow main)
        {
            InitializeComponent();
            mainWindow = main;
            windowChrome = this.chrome;
            this.Loaded += SubWindow_Loaded;
            this.Unloaded += SubWindow_Unloaded;
            this.Closed += SubWindow_Closed;
            Canvas.SetLeft(CardCanvasGrid, 0);
            Canvas.SetTop(CardCanvasGrid, 0);
            this.SourceInitialized += SubWindow_SourceInitialized;
            
        }

        private void SubWindow_Unloaded(object sender, RoutedEventArgs e)
        {
            Debug.WriteLine($"[SubWindow] Unloaded: hash={GetHashCode()}, IsVisible={IsVisible}, Visibility={Visibility}");
        }

        private void SubWindow_Closed(object sender, EventArgs e)
        {
            Debug.WriteLine($"[SubWindow] Closed: hash={GetHashCode()}, IsVisible={IsVisible}, Visibility={Visibility}");
        }

        private void SubWindow_Loaded(object sender, RoutedEventArgs e)
        {
            Debug.WriteLine($"[SubWindow] Loaded: hash={GetHashCode()}, IsVisible={IsVisible}, Visibility={Visibility}");

            // Initialize XAML Islands for this thread once.
            _windowsXamlManager ??= Windows.UI.Xaml.Hosting.WindowsXamlManager.InitializeForCurrentThread();

            customInkCanvas = new CustomInkCanvas(Writable: true);
            customInkCanvas.Name = "CardInkCanvas";
            customInkCanvas.Width = cardWidth;
            customInkCanvas.Height = cardHeight;
            customInkCanvas.VerticalAlignment = Windows.UI.Xaml.VerticalAlignment.Stretch;
            customInkCanvas.HorizontalAlignment = Windows.UI.Xaml.HorizontalAlignment.Stretch;
            customInkCanvas.Drawing += CustomInkCanvas_Drawing;
            CardInkCanvasHost = new WindowsXamlHost
            {
                InitialTypeName = "MyUWPApp.CustomInkCanvas",
                Name = "CardInkCanvasHost",
                VerticalAlignment = VerticalAlignment.Stretch,
                HorizontalAlignment = HorizontalAlignment.Stretch,
            };
            CardInkCanvasHost.ChildChanged += (_, __) =>
            {
                Debug.WriteLine($"[SubWindow] CardInkCanvasHost.ChildChanged: childType={CardInkCanvasHost.Child?.GetType().FullName ?? "<null>"}");
            };

            CardInkCanvasHost.Child = customInkCanvas;
            cardInkCanvas = customInkCanvas.InnerInkCanvas;

            CardCanvasGrid.Children.Add(CardInkCanvasHost);

            // NOTE: Do NOT call InitializeForCurrentThread again here.
            resizeInkCanvas = new CustomInkCanvas(Writable: true);
            resizeInkCanvas.Name = "ResizeInkCanvas";
            resizeInkCanvas.Width = cardWidth;
            resizeInkCanvas.Height = cardHeight;
            resizeInkCanvas.VerticalAlignment = Windows.UI.Xaml.VerticalAlignment.Stretch;
            resizeInkCanvas.HorizontalAlignment = Windows.UI.Xaml.HorizontalAlignment.Stretch;

            ResizeInkCanvasHost = new WindowsXamlHost
            {
                InitialTypeName = "MyUWPApp.CustomInkCanvas",
                Name = "ResizeInkCanvasHost",
                VerticalAlignment = VerticalAlignment.Stretch,
                HorizontalAlignment = HorizontalAlignment.Stretch
            };
            ResizeInkCanvasHost.ChildChanged += (_, __) =>
            {
                Debug.WriteLine($"[SubWindow] ResizeInkCanvasHost.ChildChanged: childType={ResizeInkCanvasHost.Child?.GetType().FullName ?? "<null>"}");
            };

            ResizeInkCanvasHost.Child = resizeInkCanvas;
            CardCanvasGrid.Children.Add(ResizeInkCanvasHost);
            ResizeInkCanvasHost.Visibility = Visibility.Hidden;

            var inkToolbar = new Microsoft.Toolkit.Wpf.UI.Controls.InkToolbar();
            inkToolbar.Visibility = Visibility.Hidden;
            CardCanvasGrid.Children.Add(inkToolbar);


            customInkToolbar.InnerInkToolbar.TargetInkCanvas = cardInkCanvas;
            cardBaseGrid = customInkCanvas.BaseGrid;
            testPict = customInkCanvas.TestPict;
            splitView = subwindow.Template.FindName("InkToolbarSplitView", subwindow) as SplitView;
            inkToolbarToggleButton = subwindow.Template.FindName("inkToolbarToggleButton", subwindow) as ToggleButton;
            OnWindowLoaded();
        }
        private void CustomInkCanvas_Drawing(object sender, EventArgs e)
        {
            if (splitView.IsPaneOpen)
            {
                splitView.IsPaneOpen = false;
            }
        }
        private void SubWindow_SourceInitialized(object sender, EventArgs e)
        {
            var hwndSource = (System.Windows.Interop.HwndSource)PresentationSource.FromVisual(this);
            hwndSource.AddHook(WndProc);
        }

        private IntPtr WndProc(IntPtr hwnd, int msg, IntPtr wParam, IntPtr lParam, ref bool handled)
        {
            // RECT 構造体を取得

            var scale = VisualTreeHelper.GetDpi(this).DpiScaleX;
            var rootGrid = (Grid)this.Template.FindName("RootGrid", this);
            var titleBar = (Grid)rootGrid.FindName("CustomTitleBar");
            double actualWidth = titleBar.ActualWidth;
            double canvasHeight = actualWidth * AspectRatio;
            double actualHeight = canvasHeight + titleBar.ActualHeight;
            switch (msg)
            {
                case WM_SHOWWINDOW:
                    widthGap = 20;
                    heightGap = (titleBar.ActualHeight) + 20;
                    windowTop = mainWindow.Top  + 30;
                    windowLeft = mainWindow.Left + 30;
                    //windowTop = 100;
                    //windowLeft = 100;
                    var rect = new RECT();
                    if (mainWindow.vm.SubWindowPosition == new Point() && mainWindow.vm.SubwindowVisible)
                    {
                        rect.Left = (int)(windowLeft * scale);
                        rect.Top = (int)(windowTop * scale);
                        rect.Right = (int)((windowLeft + cardWidth + widthGap) * scale);
                        rect.Bottom = (int)((windowTop + cardHeight + heightGap) * scale);
                    }
                    else
                        break;
                    var width = rect.Right - rect.Left;
                    var height = rect.Bottom - rect.Top;
                    
                    if(!mainWindow.vm.IsInEditMode)
                        SetWindowPos(hwnd, IntPtr.Zero, rect.Left, rect.Top, width, height, 0);
                    this.cardInkCanvas.Width = cardWidth;
                    this.cardInkCanvas.Height = cardHeight;
                    ContentRootGrid.Width = cardWidth;
                    ContentRootGrid.Height = cardHeight;
                    handled = true;
                    break;
                case WM_SYSCOMMAND:
                    if (wParam.ToInt32() == SC_MINIMIZE)
                    {
                        prevPoint = new RECT
                        {
                            Left = (int)(this.Left * scale),
                            Top = (int)(this.Top * scale),
                            Right = (int)((this.Left + actualWidth) * scale),
                            Bottom = (int)((this.Top + actualHeight) * scale)
                        };
                    }
                    break;
                case WM_SIZING:
                    currentSizingEdge = wParam.ToInt32();
                    break;

                case WM_WINDOWPOSCHANGING:
                    if (lParam != IntPtr.Zero)
                    {
                        WINDOWPOS position = Marshal.PtrToStructure<WINDOWPOS>(lParam);
                        // ウィンドウのサイズをアスペクト比に基づいて調整
                        if (currentSizingEdge != 0 && position.cx != 0 && position.cy != 0)
                        {
                            AdjustWindowSize(ref position, currentSizingEdge, scale);
                            Marshal.StructureToPtr(position, lParam, true);
                        }
                        //Debug.WriteLine($"{currentSizingEdge}, w:{this.Width}, h:{this.Height}");
                        // 構造体をポインタに書き戻す
                        //UpdateChildSizes();
                        currentSizingEdge = 0;
                    }
                    break;
                case WM_EXITSIZEMOVE:
                    break;
            }

            return IntPtr.Zero;
        }

        // サイズ変更終了時に子コントロールのサイズを更新
        private void UpdateChildSizes(double windowWidth = double.NaN, double windowHeight = double.NaN)
        {
            var scale = VisualTreeHelper.GetDpi(this).DpiScaleX;
            double clientWidth = ContentRootGrid.ActualWidth;
            double clientHeight = ContentRootGrid.ActualHeight;
            var aspect = Math.Min(clientWidth / Values.cardWidth, clientHeight / Values.cardHeight);
            
            var renderTransform = new Windows.UI.Xaml.Media.ScaleTransform();
            renderTransform.ScaleX = aspect;
            renderTransform.ScaleY = aspect;
            if (!double.IsNaN(windowHeight))
            {
                //clientHeight = (windowHeight / scale) - heightGap;
                //clientWidth = clientHeight * AspectRatio;
                clientHeight = (windowHeight / scale) - heightGap;
                clientWidth = clientHeight * AspectRatio;
            }
            else if (!double.IsNaN(windowWidth))
            {
                //clientWidth = (windowWidth / scale) - widthGap;
                //clientHeight = clientWidth / AspectRatio;
                clientWidth = (windowWidth / scale) - widthGap;
                clientHeight = clientWidth / AspectRatio;
            }
            cardInkCanvas.RenderTransform = renderTransform;

            // マージンやパディングがある場合は考慮
            double newWidth = clientWidth;
            double newHeight = clientHeight;
            if (newWidth < 0 || newHeight < 0) return;
            ContentRootGrid.Width = newWidth;
            ContentRootGrid.Height = newHeight;
            //CardCanvasGrid.Width = newWidth;
            //CardCanvasGrid.Height = newHeight;
            CardInkCanvasHost.Width = newWidth;
            CardInkCanvasHost.Height = newHeight;
            cardInkCanvas.Width = newWidth;
            cardInkCanvas.Height = newHeight;
            var childCanvas = CardInkCanvasHost.Child as MyUWPApp.CustomInkCanvas;
            childCanvas.Width = newWidth;
            childCanvas.Height = newHeight;
            CardInkCanvasHost.UpdateLayout();
            CardInkCanvasHost.InvalidateMeasure();
            cardInkCanvas.UpdateLayout();
            cardInkCanvas.InvalidateMeasure();
            //Debug.WriteLine($"Window {this.ActualWidth}, grid {CardCanvasGrid.ActualWidth}, Host {CardInkCanvasHost.ActualWidth}, inner {childCanvas.ActualWidth}, gap {widthGap}");

        }

        // サイズ変更終了時に子コントロールのサイズを更新
        // SubWindow : Windowサイズの比率を維持する処理
        private void AdjustWindowSize(ref WINDOWPOS pos, int sizingEdge, double dpiScale)
        {
            var childCanvas = CardInkCanvasHost.Child as MyUWPApp.CustomInkCanvas;
           
            if (sizingEdge != 0 && pos.cy != 0 && pos.cx != 0)
            {
                var resizeBorder = windowChrome.ResizeBorderThickness;
                switch (sizingEdge)
                {
                    case WMSZ_TOP:
                    case WMSZ_BOTTOM:
                    case WMSZ_TOPRIGHT:
                        UpdateChildSizes(windowHeight: pos.cy);
                        pos.cx = (int)(((ContentRootGrid.ActualWidth + resizeBorder.Right) * dpiScale));
                        break;

                    case WMSZ_LEFT:
                    case WMSZ_RIGHT:
                    case WMSZ_BOTTOMRIGHT:
                    case WMSZ_BOTTOMLEFT:
                        UpdateChildSizes(windowWidth: pos.cx);
                        pos.cy = (int)(((ContentRootGrid.ActualHeight + resizeBorder.Bottom) * dpiScale) + heightGap - 20);
                        break;

                    case WMSZ_TOPLEFT:
                        UpdateChildSizes(windowHeight: pos.cy);
                        pos.cx = (int)(((ContentRootGrid.ActualWidth + resizeBorder.Right) * dpiScale));
                        pos.x = (int)(pos.x - (pos.cx - this.Width * dpiScale));
                        break;
                }

            }
            pos.cx += 0;
            pos.cy += 0;
        }

        // SubWindow : Keepボタンがクリックされたときの処理
        public async void ButtonKeep_Click(object sender, RoutedEventArgs e)
        {
            
            var fourgroundStrokes = cardInkCanvas.InkPresenter.StrokeContainer.GetStrokes();
            if (fourgroundStrokes.Count == 0)
            {
                if (!mainWindow.vm.IsInEditMode) return;
                else
                {
                    CanvasClear();
                    mainWindow.vm.IsInEditMode = false;
                    mainWindow.EditingCard = null;
                }
            }
            var recogText = await RecognizeInk(cardInkCanvas.InkPresenter.StrokeContainer);

            // MainWindowにcardを渡す
            if (mainWindow == null)
                mainWindow = System.Windows.Application.Current.Windows.OfType<MainWindow>().FirstOrDefault();

            if (mainWindow != null)
            {
                var imageSource = await CaputureCanvasAsync();
                var image = new Image
                {
                    Width = imageSource.Width,
                    Height = imageSource.Height,
                    Source = imageSource
                };
                var resizedInkCanvas = new CustomInkCanvas();
                resizedInkCanvas.SetInnerCanvas(this.customInkCanvas.InnerInkCanvas);

                if (!mainWindow.vm.IsInEditMode)
                        mainWindow.AddCard(resizedInkCanvas, imageSource, recogText);
                else
                    mainWindow.FinishEditing(customInkCanvas, imageSource, recogText);
            }

            CanvasClear();
        }

        public ImageSource CaputureCanvas()
        {
            var rtb = new System.Windows.Media.Imaging.RenderTargetBitmap((int)cardInkCanvas.ActualWidth, (int)cardInkCanvas.ActualHeight, 96, 96, PixelFormats.Pbgra32);
            rtb.Render(CardCanvasGrid);
            return rtb;
        }

        public async Task<System.Windows.Media.ImageSource> CaputureCanvasAsync()
        {
            resizeInkCanvas.SetInnerCanvas(this.customInkCanvas.InnerInkCanvas);
            resizeInkCanvas.UpdateLayout();


            var renderTargetBitmap = new Windows.UI.Xaml.Media.Imaging.RenderTargetBitmap();
            await renderTargetBitmap.RenderAsync(resizeInkCanvas.InnerInkCanvas);
            
            var pixelBuffer = await renderTargetBitmap.GetPixelsAsync();
            byte[] pixels = pixelBuffer.ToArray();
            int width = renderTargetBitmap.PixelWidth;
            int height = renderTargetBitmap.PixelHeight;
            var dpi = VisualTreeHelper.GetDpi(this).DpiScaleX;

            var wb = new System.Windows.Media.Imaging.WriteableBitmap(width, height, dpi, dpi, PixelFormats.Bgra32, null);
            wb.Lock();
            wb.WritePixels(new Int32Rect(0, 0, width, height), pixels, width * 4, 0);
            wb.Unlock();
            return wb;
        }

        private async Task<string> RecognizeInk(InkStrokeContainer strokeContainer)
        {
            if (strokeContainer.GetStrokes().Count() <= 0) return "";
            InkRecognizerContainer inkRecognizer = new InkRecognizerContainer();
            var recognitionResults = await inkRecognizer.RecognizeAsync(strokeContainer, InkRecognitionTarget.All);
            var recognizedText = recognitionResults.Select(x => x.GetTextCandidates().First()).Aggregate((current, next) => current + " " + next);
            return recognizedText;
        }

        public void setEditCanvas(Card card)
        {
            this.customInkCanvas.SetInnerCanvas(card.CardCanvas);
        }

        private void ClearButton_Click(object sender, RoutedEventArgs e)
        {
            CanvasClear();
            if (mainWindow.vm.IsInEditMode) mainWindow.CancelEditing();
            
        }

        private void SplitView_PaneOpening(ModernWpf.Controls.SplitView sender, object args)
        {
            //CardCanvasHost.Visibility = Visibility.Collapsed;
        }

        private void SplitView_PaneClosed(ModernWpf.Controls.SplitView sender, object args)
        {
            //CardCanvasHost.Visibility = Visibility.Visible;
        }
        // SubWindow : キャンバスの初期化
        public void CanvasClear()
        {
            cardInkCanvas.InkPresenter.StrokeContainer.Clear();
        }

        // SubWindow : タイトルバーでウィンドウをドラッグ移動する
        private void CustomTitleBar_MouseLeftButtonDown(object sender, MouseButtonEventArgs e)
        {
            if (splitView.IsPaneOpen)
            {
                splitView.IsPaneOpen = false;
                inkToolbarToggleButton.IsChecked = false;
            }
            if (e.ButtonState == MouseButtonState.Pressed)
            {
                if (!mainWindow.vm.IsInEditMode)
                    this.DragMove();
                currentScreen = forms.Screen.FromHandle(new System.Windows.Interop.WindowInteropHelper(this).Handle);
            }

        }

        private void CardInkToolbarHost_ChildChanged(object sender, EventArgs e)
        {
            WindowsXamlHost windowsXamlHost = sender as WindowsXamlHost;
            customInkToolbar = windowsXamlHost.Child as CustomInkToolbar;
            if (customInkToolbar == null) return;
            if (customInkCanvas != null)
            {
                customInkToolbar.InnerInkToolbar.TargetInkCanvas = customInkCanvas.InnerInkCanvas;
            }
        }

        private void ToggleButton_Checked(object sender, RoutedEventArgs e)
        {
            splitView.IsPaneOpen = true;

        }

        private void ToggleButton_Unchecked(object sender, RoutedEventArgs e)
        {
            splitView.IsPaneOpen = false;

        }
        public void OnWindowLoaded()
        {
            WindowLoaded?.Invoke(null, null);
        }
    }
}
