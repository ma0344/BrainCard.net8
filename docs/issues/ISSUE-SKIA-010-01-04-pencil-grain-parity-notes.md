# ISSUE-SKIA-010-01-04 Pencil grain parity notes

このドキュメントは、SkiaSharp での鉛筆（Pencil）描画を「オリジナルに近い粒状感（モザイク寄り）＋エッジ減衰」に寄せるための、現状把握と検証・調整の手順を記録する。

## 背景 / 問題意識
- 速度（時間サンプリング密度）によって濃くなるのでは、という仮説が出た。
- 現状の `LegacyPngRenderer` の Pencil 描画は時間 `T` を参照せず、距離ベースでスタンプしているため「速度で濃くなる」設計ではない。
- ただし、stationary（ほぼ同一点）や折り返し、セグメント境界での重複スタンプにより部分的に濃くなる可能性はある。

## 現状の実装ポイント（要点）
- 入力点列:
  - `SubWindow` の自作入力は距離閾値 `MinDistanceDip=0.5` で点列を間引くため、ゆっくり描いても点が増えにくい。
  - WinRT `InkStroke` 系は時間ベースで点が増える可能性はあるが、レンダラ側が距離ベース補間なら濃度に直結しない。
- Pencil レンダリング:
  - `LegacyPngRenderer.DrawPencilStroke` が距離 `len` を使って補間スタンプ数 `steps` を決める。
  - `ComputePencilAlphaMultiplier(step/(radius*densityRef))` で重なり補正して過度な濃さを抑える。
  - `StampSoftCircle` が「半径＋radial falloff＋noise(DstIn)」で粉っぽい質感を作る。

## 検証の優先順位（潰し込み方針）

### 1) まず「濃さが速度依存か」を切り分ける
目的: 速度依存が本当にあるのか／あるならどこで生じているのか。
- Pencil は時間 `T` を使っていないため、速度依存が出る場合は
  - (A) 同一点近傍への多重スタンプ（stationary/折り返し/境界）
  - (B) 入力点列の座標揺れ（停止しているつもりでも微小移動として扱われる）
  の可能性が高い。

手法:
- 同一の筆圧で「短距離を速く」「短距離を遅く」を比較（PNG差分 or 目視）。
- 同一点近傍に戻る折り返しを含むストロークを作り、局所的な濃さが増えるかを確認。

### 2) 次に「粒状感（grain）不足」を詰める
目的: オリジナルの“モザイクに近い粒度”を再現。
- 現行は `PencilBrushTexture.CreateAlphaNoise` が連続値 + 平滑化で、雲状/粉状になりやすい。
- オリジナルがモザイク寄りの場合、以下が有効:
  - ブロック（セル）単位で一定値のノイズ（block/cell noise）
  - 量子化（段階化）
  - アンチエイリアスの影響を減らす（境界の平均化を避ける）

手法（Copilot提案の具体項目）:
- 2-1) 粒サイズ（見た目の粗さ）の制御: `LegacyPngRenderer.StampSoftCircle` のノイズ尺度
  - ノイズの `sx/sy` を調整して、スタンプ内のタイル回数を減らす（粒を大きく見せる）。
  - 既存コードの方向性: `noiseScale` を半径依存にし、大小スタンプで破綻しない範囲で増やす。
- 2-2) 粒のシャープさ（滲み抑制）: `PencilBrushTexture.CreateAlphaNoise` の平滑化
  - 3x3近傍平均を弱める／中心重みを増やして周囲の影響を下げる。
  - さらにモザイク寄りが必要なら、平滑化をオフに近づける。
- 2-3) AA の影響の確認（重要な観察）
  - `IsAntialias=false` で粒状感が上がったのは、境界がサブピクセル平均化されずピクセル格子に乗るため。
  - 副作用（輪郭のギザ）を避けるなら、
    - スタンプ円の paint ではなく、noise(DstIn) の paint だけ AA を切る、など「切る対象」を局所化して試す。

### 3) 「エッジ減衰（falloff）不足」を詰める
目的: 鉛筆っぽい外周の落ち方を近づける。
- `StampSoftCircle` の radial gradient の中間位置 `maskMidPos`、中間alpha `maskMidA` が支配的。
- 手法:
  - `maskMidPos` を内側に寄せる（例: 0.50 → 0.40?0.45）
  - `maskMidA` を下げる（外周をより薄く）
  - 小さいスタンプ時の `midPos` 分岐（`maskRadius<=3` など）が影響するため、極小半径の見た目も確認

## 代替案としての Perlin/Fractal(FBM) の位置づけ
- `CreatePerlinNoiseFractalNoise` 的な多スケール合成は「自然なザラつき」には強いが、
  そのままだと連続/滑らかになり、モザイク粒度の再現には不利。
- ただし保険アイデアとしては有効で、使い方は以下が実用的:
  1. FBM を粒そのものではなく「密度マップ（出やすさ）」に使う（ムラ担当）
  2. FBM 出力を量子化して段階化する（モザイク寄りへ）
  3. ブロックノイズ（セル）を主役にして FBM を変調に使う（タイル感維持＋自然なムラ）

## ここまでの Copilot 提案（実施済みの変更内容）
- 粒を大きく: `LegacyPngRenderer.StampSoftCircle` の `noiseScale` を半径依存に変更（大きめ方向へ）。
- 粒をシャープに: `PencilBrushTexture.CreateAlphaNoise` の 3x3 平滑化の中心重みを増やし、滲みを抑制。
- 濃さの局所増加: stationary/折り返しで同一点近傍に多重スタンプしないようスキップ方向の対策を導入。

※PNGキャッシュ更新や比較は環境依存のため、ユーザー側で実施する。

## 次に試す具体手法（候補）

### A) モザイク粒度へ寄せる（最有力）
- `PencilBrushTexture` のノイズ生成を「ブロックノイズ（block/cell noise）」へ寄せる
  - ブロック単位で一定 alpha を割り当てる
  - 平滑化は最小限
  - ブロックサイズ（例: 4px?8px）を調整して粒度を合わせる

### B) AA を局所的に切る
- `StampSoftCircle` の
  - noise(DstIn) 側の `SKPaint.IsAntialias` のみ false
  - あるいはスタンプ円も含めて false
を試して、粒状感と輪郭品質のトレードオフを観察する。

### C) FBM を「変調」として足す（保険案）
- （粒）block noise × （ムラ）low-frequency FBM × （段階化）quantize
- 目的は「モザイク粒を壊さず、濃淡の自然さを足す」

## 検証チェックリスト（手動）
- 太い筆圧域で粒が面状に出るか（粒が大きいか）
- 粒の境界が滲まず残るか（シャープか）
- エッジ外周の落ち方が足りているか（中間位置/中間alphaの効果）
- 折り返しや停止で不自然に濃い塊が出ないか（同一点近傍の多重スタンプ抑制）

