# BrainCard ファイル形式 v2（`.bcf2`）仕様

本ドキュメントは、BrainCard の新ファイル形式 v2（拡張子 `.bcf2`）の仕様を定義します。

## 1. 目的
- WPF版で Ink を Win2D ベースへ移行するための、ストローク保存フォーマットを定義する
- 旧形式（`.bcf` / ISF）は **読み込みのみ**を可能にし、保存は **必ず v2** とする
- `MainWindow` のカード表示は **PNG** を正とし、Inkデータは再編集用のソースとする

## 2. 対応方針（互換性）
### 2.1 旧形式（`.bcf`）
- 読み込み: 対応（既存実装を維持しつつ v2 内部モデルへ変換）
- 保存: **非対応**（旧拡張子への保存・上書きは禁止）

### 2.2 新形式（`.bcf2`）
- 読み込み: 対応
- 保存: 対応（唯一の保存形式）

## 3. 物理構成
- `.bcf2` は **UTF-8 の JSON** とする
- PNG は `(<ファイルパス>).Assets/<cardId>.png` に保存し、JSON内から参照する
  - 例: `C:\path\note.bcf2.Assets\<id>.png`

## 4. 論理構成（JSONスキーマ概略）
### 4.1 ルート
- `format` : 固定文字列 `"BrainCard"`
- `version` : 整数 `2`
- `createdUtc` : ISO-8601 UTC（任意）
- `canvas` : 既定キャンバス情報（任意。未設定の場合はアプリ既定値）
- `cards` : カード配列（必須）

```json
{
  "format": "BrainCard",
  "version": 2,
  "createdUtc": "2026-01-08T00:00:00Z",
  "canvas": {
    "width": 395,
    "height": 279,
    "dpi": 96
  },
  "cards": [
    {
      "id": "a1b2c3...",
      "x": 120.0,
      "y": 50.0,
      "z": 3,
      "recognizedText": "...",
      "previewPng": "a1b2c3....png",
      "ink": {
        "model": "stroke-v1",
        "units": "dip",
        "strokes": []
      }
    }
  ]
}
```

### 4.2 `canvas`
- `width`/`height`: DIP
- `dpi`: 既定 96（保存時は 96 を推奨）

### 4.3 `cards[]`
- `id`: 文字列（GUID相当、`Assets`用のファイル名に利用）
- `x`/`y`: 配置座標（DIP）
- `z`: Z順（整数）
- `recognizedText`: 認識テキスト（任意。現状維持用）
- `previewPng`: プレビューPNGのファイル名（例: `<id>.png`）
- `ink`: Inkデータ（再編集用）

### 4.4 `ink`
- `model`: 固定 `"stroke-v1"`
- `units`: 固定 `"dip"`
- `strokes`: ストローク配列

## 5. ストロークモデル（`stroke-v1`）
### 5.1 `stroke`
- `id`: ストロークID（任意。未設定でも可）
- `tool`: `"pen"` または `"highlighter"`（将来拡張可）
- `color`: `#AARRGGBB`
- `size`: ベース太さ（DIP）
- `opacity`: 0..1（任意。`color` の A と整合してもよい）
- `deviceKind`: `"pen" | "mouse" | "touch" | "unknown"`（任意）
- `points`: 点列（必須）

```json
{
  "id": "s-0001",
  "tool": "pen",
  "color": "#FF000000",
  "size": 2.0,
  "opacity": 1.0,
  "deviceKind": "pen",
  "points": [
    { "x": 10.2, "y": 20.1, "pr": 0.50, "t": 0 },
    { "x": 10.4, "y": 20.6, "pr": 0.52, "t": 8 }
  ]
}
```

### 5.2 `point`
- `x`/`y`: 座標（DIP）
- `pr`: 筆圧 0..1
  - ペン以外（mouse/touch）は 1.0 を設定する
- `t`: ストローク開始からの相対ミリ秒（`int`）
  - 先頭点は `t=0` を推奨

## 6. 消しゴム仕様
- 消しゴム操作自体は保存しない
- 保存するのは **可視状態で残っているストロークのみ**
- 消しゴムにより消されたストロークは、モデル上 **削除**された結果として反映される
- 部分消去（1本のストロークを分割して残す）は本仕様では想定しない

## 7. `t`（時間）補完ルール
### 7.1 新方式（Win2D編集ビュー）
- 可能な限り実時間に基づいて `t` を記録する
  - ストローク開始時刻を0として、以降の点は差分ms

### 7.2 旧ISF読み込み時（`t` が取得できない場合）
- `t` は **速度推定**により補完する
  - 目標: UWP InkCanvasの体感に近づける（過度にゼロ詰めしない）

#### 推定の考え方（仕様）
- 点間距離 `d`（DIP）から点間時間 `dt`（ms）を求め、累積して `t` を作る
- 基本速度 `v`（DIP/ms）を定数として用いる
  - 例: `v = 1.0`（= 1000DIP/秒相当）など、実装時に調整可能な定数
- `dt = clamp(round(d / v), dtMin, dtMax)`
  - `dtMin`: 1ms（0msが連続しないようにする）
  - `dtMax`: 40ms（急な飛びを抑え、極端な遅延を防ぐ）

※ `v/dtMin/dtMax` は初期値として実装し、必要に応じて調整できるようにする。

## 8. PNG運用
- `previewPng` が存在する場合は、`MainWindow` のカード表示は基本的にそれを使用する
- `previewPng` が無い場合（または欠損している場合）は、`ink` から再生成して `Assets` に保存する

## 9. 保存時の拡張子強制
- 保存UI（Save/SaveAs）は `.bcf2` のみを許可する
- `.bcf` への保存、`.bcf` の上書き保存は不可
- `.bcf` を開いた状態で保存操作が行われた場合、必ず `.bcf2` への「名前を付けて保存」へ誘導する

## 10. 将来拡張
- 互換性維持のため、
  - ルートの `version`
  - `ink.model`
  を用いてバージョニングする
- 未知プロパティは読み込み時に無視できる設計とする（JSONの前方互換）

## 11. Assetsキャッシュの整合性（保存時のクリーンアップ）
- SaveAs等で既存の`.bcf2`へ保存する場合、過去に存在したカードのPNGが`(<file>.Assets)`に残ると表示や運用を誤るため、保存時に整合性を取る
- 方針:
  - 正: 現在の`cards[].id`集合
  - `(<file>.Assets)`直下の`*.png`のうち、`<cardId>.png`に一致しないものは削除する
  - サブディレクトリ配下は対象外（直下のみ）
